---
- name: Prepare nodes for Kubernetes
  hosts: all
  become: true
  vars:
    ssh_keys_dir: "../ssh-keys"
  tasks:
    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: /home/vagrant/.ssh
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0700'

    - name: Ensure authorized_keys file exists
      ansible.builtin.file:
        path: /home/vagrant/.ssh/authorized_keys
        owner: vagrant
        group: vagrant
        mode: '0600'
        state: touch

    - name: Add SSH public keys from shared folder
      ansible.posix.authorized_key:
        user: vagrant
        state: present
        key: "{{ lookup('file', item) }}"
      with_fileglob:
        - "{{ ssh_keys_dir }}/*.pub"

    - name: Disable swap
      ansible.builtin.command: swapoff -a
      changed_when: false

    - name: Remove swap from fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: '^.*swap.*$'
        state: absent

    - name: Ensure swap is disabled with mount module
      ansible.builtin.mount:
        name: swap
        fstype: swap
        state: absent

    - name: Ensure Kubernetes kernel modules are configured to load at boot
      ansible.builtin.copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
        owner: root
        group: root
        mode: '0644'

    - name: Ensure overlay kernel module is loaded
      community.general.modprobe:
        name: overlay
        state: present

    - name: Ensure br_netfilter kernel module is loaded
      community.general.modprobe:
        name: br_netfilter
        state: present

    - name: Enable IPv4 forwarding
      ansible.builtin.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        reload: true
        sysctl_set: true

    - name: Enable bridged iptables
      ansible.builtin.sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: '1'
        state: present
        reload: true
        sysctl_set: true

    - name: Enable bridged ip6tables
      ansible.builtin.sysctl:
        name: net.bridge.bridge-nf-call-ip6tables
        value: '1'
        state: present
        reload: true
        sysctl_set: true

    - name: Insert hosts block
      ansible.builtin.template:
        src: ./templates/hosts_block.j2
        dest: /etc/hosts
        owner: root
        group: root
        mode: '0644'

    # ----------------------------
    # Kubernetes key & repository
    # ----------------------------
    - name: Ensure keyring directory exists
      ansible.builtin.file:
        path: /usr/share/keyrings
        state: directory
        mode: '0755'

    - name: Remove old Kubernetes keyring if exists
      ansible.builtin.file:
        path: /usr/share/keyrings/kubernetes-apt-keyring.gpg
        state: absent

    - name: Download Kubernetes apt key
      ansible.builtin.get_url:
        url: https://prod-cdn.packages.k8s.io/repositories/isv:/kubernetes:/core:/stable:/v1.34/deb/Release.key
        dest: /usr/share/keyrings/kubernetes-apt-keyring.asc
        mode: '0644'

    - name: Convert Kubernetes apt key to keyring format
      ansible.builtin.command:
        argv:
          - gpg
          - --dearmor
          - --yes
          - -o
          - /usr/share/keyrings/kubernetes-apt-keyring.gpg
          - /usr/share/keyrings/kubernetes-apt-keyring.asc
      args:
        creates: /usr/share/keyrings/kubernetes-apt-keyring.gpg
      changed_when: false

    - name: Set permissions on Kubernetes keyring
      ansible.builtin.file:
        path: /usr/share/keyrings/kubernetes-apt-keyring.gpg
        owner: root
        group: root
        mode: '0644'

    - name: Add Kubernetes apt repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/kubernetes-apt-keyring.gpg] https://prod-cdn.packages.k8s.io/repositories/isv:/kubernetes:/core:/stable:/v1.34/deb/ /"
        state: present
        filename: kubernetes

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    # ----------------------------
    # Container runtime and Kubernetes tools
    # ----------------------------
    - name: Install containerd and runc
      ansible.builtin.apt:
        name:
          - containerd
          - runc
        state: present

    - name: Install Kubernetes tools
      ansible.builtin.apt:
        name:
          - kubeadm
          - kubelet
          - kubectl
        state: present

    - name: Ensure containerd config directory exists
      ansible.builtin.file:
        path: /etc/containerd
        state: directory
        mode: "0755"

    - name: Generate default containerd configuration
      ansible.builtin.command: containerd config default
      register: containerd_default
      changed_when: false

    - name: Write base containerd config
      ansible.builtin.copy:
        dest: /etc/containerd/config.toml
        mode: "0644"
        content: "{{ containerd_default.stdout }}"

    - name: Disable AppArmor in containerd config
      ansible.builtin.lineinfile:
        path: /etc/containerd/config.toml
        regexp: '^\s*disable_apparmor\s*=\s*false'
        line: '    disable_apparmor = true'
        backrefs: true

    - name: Set pause sandbox image to registry.k8s.io/pause:3.10
      ansible.builtin.lineinfile:
        path: /etc/containerd/config.toml
        regexp: '^\s*sandbox_image\s*=\s*".*"'
        line: '    sandbox_image = "registry.k8s.io/pause:3.10"'
        backrefs: true

    - name: Enable SystemdCgroup in containerd
      ansible.builtin.lineinfile:
        path: /etc/containerd/config.toml
        regexp: '^\s*SystemdCgroup\s*=\s*false'
        line: '            SystemdCgroup = true'
        backrefs: true

    - name: Restart containerd with new configuration
      ansible.builtin.service:
        name: containerd
        state: restarted
        enabled: true

    - name: Ensure kubelet is enabled and started
      ansible.builtin.service:
        name: kubelet
        state: started
        enabled: true

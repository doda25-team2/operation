---

# ansible-playbook -u vagrant -i 192.168.56.100, ./ansible/finalization.yml
# or if using WSL:
# ansible-playbook -i ./ansible/inventory-wsl.ini ./ansible/finalization.yml

- hosts: all
  become: yes
  gather_facts: yes

  vars:
    metallb_version: "0.14.9"
    metallb_ip_range: "192.168.56.90-192.168.56.99"
    ingress_nginx_controller_ip: "192.168.56.95"
    
  environment:
    KUBECONFIG: /home/vagrant/.kube/config

  tasks:
    # Step 20: Install MetalLB
    - name: Download MetalLB native manifest
      get_url:
        url: "https://raw.githubusercontent.com/metallb/metallb/v{{ metallb_version }}/config/manifests/metallb-native.yaml"
        dest: /tmp/metallb-native.yaml
        mode: '0644'
      tags:
        - metallb

    - name: Apply MetalLB manifest
      command: kubectl apply -f /tmp/metallb-native.yaml
      environment:
        KUBECONFIG: /home/vagrant/.kube/config
      tags:
        - metallb

    - name: Wait for MetalLB controller to be ready
      command: >
        kubectl wait -n metallb-system
        -l app=metallb,component=controller
        --for=condition=ready pod
        --timeout=120s
      retries: 3
      delay: 10
      register: metallb_wait
      until: metallb_wait.rc == 0
      tags:
        - metallb

    # This is a workaround for the famous Failed calling webhook "ipaddresspoolvalidationwebhook.metallb.io"
    - name: Temporarily delete webhook configuration to allow resource creation
      command: kubectl delete validatingwebhookconfiguration metallb-webhook-configuration
      ignore_errors: yes
      tags:
        - metallb

    - name: Copy MetalLB IPAddressPool manifest
      copy:
        src: ../k8s/metallb-ippool.yaml
        dest: /tmp/metallb-ippool.yaml
        mode: '0644'
      tags:
        - metallb

    - name: Apply MetalLB IPAddressPool
      command: kubectl apply -f /tmp/metallb-ippool.yaml
      tags:
        - metallb

    - name: Copy MetalLB L2Advertisement manifest
      copy:
        src: ../k8s/metallb-l2advert.yaml
        dest: /tmp/metallb-l2advert.yaml
        mode: '0644'
      tags:
        - metallb

    - name: Apply MetalLB L2Advertisement
      become_user: vagrant
      command: kubectl apply -f /tmp/metallb-l2advert.yaml
      tags:
        - metallb
      
    # Step 21: Install the Nginx Ingress Controller
    - name: Ensure ingress-nginx Helm repository is present
      command: >
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
      register: add_ingress_repo
      failed_when: add_ingress_repo.rc != 0 and
                   "'already exists' not in add_ingress_repo.stderr"
      changed_when: "'already exists' not in add_ingress_repo.stderr"
      tags:
        - ingress

    - name: Refresh Helm repositories cache
      command: helm repo update
      tags:
        - ingress

    - name: Verify existing ingress-nginx installation
      command: helm status ingress-nginx -n ingress-nginx
      register: ingress_status
      changed_when: false
      failed_when: false
      tags:
        - ingress

    - name: Deploy or upgrade NGINX Ingress Controller
      command: >
        helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx
        --namespace ingress-nginx
        --create-namespace
        --set controller.service.loadBalancerIP={{ ingress_nginx_controller_ip }}
      when: ingress_status.rc != 0
      tags:
        - ingress

    - name: Wait for ingress controller pods to become Ready
      command: >
        kubectl wait -n ingress-nginx pod
        --selector=app.kubernetes.io/component=controller
        --for=condition=Ready
        --timeout=180s
      retries: 2
      delay: 15
      register: ingress_ready
      until: ingress_ready.rc == 0
      tags:
        - ingress
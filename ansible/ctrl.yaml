---
- name: Initialize Kubernetes control plane
  hosts: all
  become: true
  tasks:
    - name: Check if kubeadm already initialized
      ansible.builtin.stat:
        path: /etc/kubernetes/admin.conf
      register: kubeinit

    - name: Run kubeadm init
      ansible.builtin.command: >
        kubeadm init
        --apiserver-advertise-address={{ ctrl_ip }}
        --node-name ctrl
        --pod-network-cidr=10.244.0.0/16
      when: not kubeinit.stat.exists
      changed_when: true

    - name: Ensure .kube directory exists for vagrant
      ansible.builtin.file:
        path: /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant
        mode: "0755"

    - name: Copy admin.conf to vagrant user
      ansible.builtin.copy:
        remote_src: true
        src: /etc/kubernetes/admin.conf
        dest: /home/vagrant/.kube/config
        owner: vagrant
        group: vagrant
        mode: "0600"

    - name: Copy admin.conf to host shared folder
      ansible.builtin.copy:
        remote_src: true
        src: /etc/kubernetes/admin.conf
        dest: /vagrant/admin.conf
        mode: "0644"

    - name: Download Flannel manifest
      ansible.builtin.get_url:
        url: https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
        dest: /tmp/kube-flannel.yml
        mode: "0644"

    - name: Patch Flannel DaemonSet to use eth1
      ansible.builtin.lineinfile:
        path: /tmp/kube-flannel.yml
        insertafter: '^\s+- --kube-subnet-mgr$'
        line: '        - --iface=eth1'
        state: present

    - name: Apply Flannel network
      ansible.builtin.command: kubectl apply -f /tmp/kube-flannel.yml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: flannel_apply
      changed_when: '"configured" in flannel_apply.stdout or "created" in flannel_apply.stdout'

    - name: Install Helm via official script
      ansible.builtin.shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        executable: /bin/bash
      when: not kubeinit.stat.exists
      changed_when: true

    - name: Install helm-diff plugin
      become_user: vagrant
      ansible.builtin.shell: helm plugin install https://github.com/databus23/helm-diff || true
      args:
        executable: /bin/bash
      when: not kubeinit.stat.exists
      changed_when: false
